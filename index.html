import React, { useState, useEffect, useMemo } from 'react';
import { 
  LayoutDashboard, 
  Package, 
  ShoppingCart, 
  RotateCcw, 
  Users, 
  UserSquare2, 
  Clock, 
  BarChart3, 
  Wallet, 
  Bell, 
  Plus, 
  Search, 
  Printer, 
  LogOut,
  ChevronRight,
  AlertTriangle,
  Settings,
  ShieldCheck,
  ShoppingBag
} from 'lucide-react';

// --- بيانات تجريبية أولية ---
const initialItems = [
  { id: 1, name: 'منتج أ', category: 'غذائية', price: 50, buyPrice: 40, quantity: 100, expiryDate: '2026-02-15', minQty: 10 },
  { id: 2, name: 'منتج ب', category: 'إلكترونيات', price: 1200, buyPrice: 1000, quantity: 5, expiryDate: '2028-12-01', minQty: 2 },
  { id: 3, name: 'منتج ج', category: 'منظفات', price: 25, buyPrice: 15, quantity: 50, expiryDate: '2026-01-25', minQty: 15 },
];

const initialEmployees = [
  { id: 1, name: 'أحمد محمد', role: 'كاشير', shift: 'صباحي', salary: 3000 },
  { id: 2, name: 'سارة خالد', role: 'محاسب', shift: 'مسائي', salary: 4500 },
];

const App = () => {
  // --- الحالات العامة (State) ---
  const [view, setView] = useState('dashboard'); // dashboard, pos, inventory, returns, debts, reports, employees, customers_portal
  const [userRole, setUserRole] = useState('manager'); // manager, employee, customer
  const [items, setItems] = useState(initialItems);
  const [sales, setSales] = useState([]);
  const [debts, setDebts] = useState([
    { id: 1, customerName: 'علي حسن', amount: 500, phone: '0501234567' }
  ]);
  const [employees, setEmployees] = useState(initialEmployees);
  const [cart, setCart] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');

  // --- التنبيهات (الانتهاء والكمية) ---
  useEffect(() => {
    const alerts = [];
    const today = new Date();
    const nextMonth = new Date();
    nextMonth.setMonth(today.getMonth() + 1);

    items.forEach(item => {
      const expDate = new Date(item.expiryDate);
      if (expDate <= today) {
        alerts.push({ type: 'error', message: `المنتج ${item.name} منتهي الصلاحية!` });
      } else if (expDate <= nextMonth) {
        alerts.push({ type: 'warning', message: `المنتج ${item.name} يقترب من الانتهاء (${item.expiryDate})` });
      }
      if (item.quantity <= item.minQty) {
        alerts.push({ type: 'info', message: `المنتج ${item.name} على وشك النفاذ (الكمية: ${item.quantity})` });
      }
    });
    setNotifications(alerts);
  }, [items]);

  // --- دوال العمليات ---
  const addToCart = (item) => {
    if (item.quantity <= 0) return;
    const existing = cart.find(c => c.id === item.id);
    if (existing) {
      setCart(cart.map(c => c.id === item.id ? { ...c, cartQty: c.cartQty + 1 } : c));
    } else {
      setCart([...cart, { ...item, cartQty: 1 }]);
    }
  };

  const completeSale = (isDebt = false, customerName = '') => {
    if (cart.length === 0) return;
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.cartQty), 0);
    const newSale = {
      id: Date.now(),
      items: [...cart],
      total,
      date: new Date().toLocaleString('ar-SA'),
      type: isDebt ? 'دين' : 'نقدي'
    };

    setSales([newSale, ...sales]);
    
    // تحديث المخزون
    const updatedItems = items.map(item => {
      const cartItem = cart.find(c => c.id === item.id);
      return cartItem ? { ...item, quantity: item.quantity - cartItem.cartQty } : item;
    });
    setItems(updatedItems);

    if (isDebt && customerName) {
      setDebts([...debts, { id: Date.now(), customerName, amount: total, phone: '-' }]);
    }

    setCart([]);
    window.print(); // محاكاة الطباعة
  };

  // --- المكونات الفرعية (Sub-components) ---

  const SidebarItem = ({ icon: Icon, label, id, active }) => (
    <button
      onClick={() => setView(id)}
      className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${
        active ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'
      }`}
    >
      <Icon size={20} />
      <span className="font-medium text-sm">{label}</span>
    </button>
  );

  const StatCard = ({ title, value, color, icon: Icon }) => (
    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
      <div>
        <p className="text-gray-500 text-sm mb-1">{title}</p>
        <h3 className="text-2xl font-bold text-gray-800">{value}</h3>
      </div>
      <div className={`p-3 rounded-xl ${color}`}>
        <Icon className="text-white" size={24} />
      </div>
    </div>
  );

  // --- الواجهات الرئيسية ---

  const DashboardView = () => (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard title="إجمالي المبيعات" value={`${sales.reduce((s, a) => s + a.total, 0)} ر.س`} color="bg-green-500" icon={Wallet} />
        <StatCard title="عدد المنتجات" value={items.length} color="bg-blue-500" icon={Package} />
        <StatCard title="الديون المستحقة" value={`${debts.reduce((s, a) => s + a.amount, 0)} ر.س`} color="bg-red-500" icon={AlertTriangle} />
        <StatCard title="إجمالي الموظفين" value={employees.length} color="bg-purple-500" icon={Users} />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Bell className="text-amber-500" /> تنبيهات هامة
          </h3>
          <div className="space-y-3">
            {notifications.length > 0 ? notifications.map((n, i) => (
              <div key={i} className={`p-3 rounded-lg border-r-4 flex items-center gap-3 text-sm ${
                n.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' : 
                n.type === 'warning' ? 'bg-amber-50 border-amber-500 text-amber-700' : 
                'bg-blue-50 border-blue-500 text-blue-700'
              }`}>
                <AlertTriangle size={16} />
                {n.message}
              </div>
            )) : <p className="text-gray-400 text-center py-4">لا توجد تنبيهات حالياً</p>}
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold mb-4">آخر العمليات</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-right text-sm">
              <thead>
                <tr className="text-gray-400 border-b">
                  <th className="pb-3 font-medium">التاريخ</th>
                  <th className="pb-3 font-medium">النوع</th>
                  <th className="pb-3 font-medium">المبلغ</th>
                </tr>
              </thead>
              <tbody>
                {sales.slice(0, 5).map(sale => (
                  <tr key={sale.id} className="border-b last:border-0 hover:bg-gray-50">
                    <td className="py-3">{sale.date}</td>
                    <td className="py-3">
                      <span className={`px-2 py-1 rounded-full text-xs ${sale.type === 'نقدي' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                        {sale.type}
                      </span>
                    </td>
                    <td className="py-3 font-bold">{sale.total} ر.س</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );

  const POSView = () => (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
      {/* قائمة المنتجات */}
      <div className="lg:col-span-2 space-y-4 flex flex-col">
        <div className="relative">
          <Search className="absolute right-3 top-3 text-gray-400" size={20} />
          <input 
            type="text" 
            placeholder="ابحث عن منتج..." 
            className="w-full pr-10 pl-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto pr-2">
          {items.filter(i => i.name.includes(searchTerm)).map(item => (
            <div 
              key={item.id}
              onClick={() => addToCart(item)}
              className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:border-blue-500 cursor-pointer transition-all active:scale-95 group"
            >
              <div className="w-full aspect-square bg-gray-50 rounded-xl mb-3 flex items-center justify-center text-gray-300 group-hover:text-blue-500">
                <Package size={40} />
              </div>
              <h4 className="font-bold text-gray-800 text-sm truncate">{item.name}</h4>
              <p className="text-blue-600 font-bold mt-1">{item.price} ر.س</p>
              <div className="flex justify-between items-center mt-2 text-[10px] text-gray-500">
                <span>المخزون: {item.quantity}</span>
                <span className={new Date(item.expiryDate) < new Date() ? 'text-red-500' : ''}>
                  {item.expiryDate}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* سلة البيع */}
      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden">
        <div className="p-4 border-b bg-gray-50">
          <h3 className="font-bold flex items-center gap-2">
            <ShoppingCart size={18} /> فاتورة جديدة
          </h3>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {cart.map((item, idx) => (
            <div key={idx} className="flex justify-between items-center text-sm bg-gray-50 p-2 rounded-lg">
              <div>
                <p className="font-bold">{item.name}</p>
                <p className="text-gray-500 text-xs">{item.cartQty} x {item.price} ر.س</p>
              </div>
              <button 
                onClick={() => setCart(cart.filter((_, i) => i !== idx))}
                className="text-red-500 p-1 hover:bg-red-50 rounded"
              >
                <LogOut size={16} />
              </button>
            </div>
          ))}
          {cart.length === 0 && <p className="text-center text-gray-400 mt-10">السلة فارغة</p>}
        </div>
        <div className="p-4 border-t bg-gray-50 space-y-4">
          <div className="flex justify-between items-center text-lg font-bold">
            <span>الإجمالي:</span>
            <span className="text-blue-600">{cart.reduce((s, i) => s + (i.price * i.cartQty), 0)} ر.س</span>
          </div>
          <div className="grid grid-cols-2 gap-2">
            <button 
              onClick={() => completeSale(false)}
              className="bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
            >
              <Printer size={18} /> نقدي
            </button>
            <button 
              onClick={() => {
                const name = prompt("اسم العميل للآجل:");
                if (name) completeSale(true, name);
              }}
              className="bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition-colors"
            >
              آجل (دين)
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  const InventoryView = () => (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden animate-in slide-in-from-bottom-4 duration-500">
      <div className="p-6 border-b flex justify-between items-center">
        <h3 className="text-xl font-bold">إدارة المخزون</h3>
        <button className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
          <Plus size={18} /> إضافة صنف جديد
        </button>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-right">
          <thead>
            <tr className="bg-gray-50 text-gray-500 text-sm">
              <th className="p-4 font-medium">المنتج</th>
              <th className="p-4 font-medium">الفئة</th>
              <th className="p-4 font-medium">سعر التكلفة</th>
              <th className="p-4 font-medium">سعر البيع</th>
              <th className="p-4 font-medium">الكمية</th>
              <th className="p-4 font-medium">تاريخ الصلاحية</th>
              <th className="p-4 font-medium">الحالة</th>
            </tr>
          </thead>
          <tbody>
            {items.map(item => (
              <tr key={item.id} className="border-b hover:bg-gray-50 transition-colors">
                <td className="p-4 font-bold">{item.name}</td>
                <td className="p-4 text-sm">{item.category}</td>
                <td className="p-4 text-sm text-gray-500">{item.buyPrice} ر.س</td>
                <td className="p-4 font-bold text-blue-600">{item.price} ر.س</td>
                <td className="p-4">
                   <span className={`font-bold ${item.quantity <= item.minQty ? 'text-red-600' : 'text-green-600'}`}>
                    {item.quantity}
                   </span>
                </td>
                <td className="p-4 text-sm">{item.expiryDate}</td>
                <td className="p-4">
                  <span className={`px-2 py-1 rounded text-xs ${new Date(item.expiryDate) < new Date() ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                    {new Date(item.expiryDate) < new Date() ? 'منتهي' : 'سليم'}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  const CustomerPortal = () => (
    <div className="space-y-6">
      <div className="bg-blue-600 p-8 rounded-3xl text-white">
        <h2 className="text-2xl font-bold mb-2">مرحباً بك في متجرنا</h2>
        <p className="opacity-90">يمكنك تصفح الأسعار والمنتجات المتاحة وتواريخ الصلاحية</p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {items.map(item => (
          <div key={item.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
             <div className="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-4">
                <ShoppingBag size={32} />
             </div>
             <h3 className="font-bold text-lg">{item.name}</h3>
             <p className="text-blue-600 font-bold text-xl my-2">{item.price} ر.س</p>
             <div className="text-sm text-gray-500 space-y-1">
                <p>الكمية المتوفرة: {item.quantity}</p>
                <p>تاريخ الصلاحية: {item.expiryDate}</p>
             </div>
             <button className="mt-4 w-full bg-gray-100 text-gray-800 py-2 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                طلب المنتج
             </button>
          </div>
        ))}
      </div>
    </div>
  );

  const EmployeesView = () => (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-6">
      <div className="flex justify-between items-center">
        <h3 className="text-xl font-bold">الموظفون وأوقات العمل</h3>
        <button className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
          <Plus size={18} /> إضافة موظف
        </button>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {employees.map(emp => (
          <div key={emp.id} className="p-4 border rounded-xl flex items-center gap-4">
            <div className="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold">
              {emp.name[0]}
            </div>
            <div className="flex-1">
              <h4 className="font-bold">{emp.name}</h4>
              <p className="text-sm text-gray-500">{emp.role} - دوام {emp.shift}</p>
            </div>
            <div className="text-left">
              <p className="text-xs text-gray-400">الراتب</p>
              <p className="font-bold text-green-600">{emp.salary} ر.س</p>
            </div>
          </div>
        ))}
      </div>
      <div className="mt-8 border-t pt-6">
        <h4 className="font-bold mb-4 flex items-center gap-2"><Clock size={18} /> سجل الحضور (اليوم)</h4>
        <div className="bg-gray-50 rounded-xl p-4 text-sm text-gray-500 text-center">
          سجل الحضور الذكي يتم تحديثه آلياً عند تسجيل الدخول للنظام
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-right font-sans flex overflow-hidden" dir="rtl">
      
      {/* القائمة الجانبية (Sidebar) */}
      {userRole !== 'customer' && (
        <aside className="w-64 bg-gray-900 h-screen p-4 flex flex-col shrink-0">
          <div className="flex items-center gap-3 px-2 mb-10 text-white">
            <div className="bg-blue-600 p-2 rounded-xl">
              <LayoutDashboard size={24} />
            </div>
            <h1 className="font-black text-xl tracking-tight">محاسب برو</h1>
          </div>

          <nav className="flex-1 space-y-2">
            <SidebarItem icon={LayoutDashboard} label="لوحة التحكم" id="dashboard" active={view === 'dashboard'} />
            <SidebarItem icon={ShoppingCart} label="نقطة البيع (POS)" id="pos" active={view === 'pos'} />
            <SidebarItem icon={Package} label="المخزون" id="inventory" active={view === 'inventory'} />
            <SidebarItem icon={RotateCcw} label="المرتجعات" id="returns" active={view === 'returns'} />
            <SidebarItem icon={Wallet} label="الديون" id="debts" active={view === 'debts'} />
            <SidebarItem icon={Users} label="الموظفون" id="employees" active={view === 'employees'} />
            <SidebarItem icon={BarChart3} label="التقارير" id="reports" active={view === 'reports'} />
          </nav>

          <div className="mt-auto pt-6 border-t border-gray-800 space-y-2">
             <button 
              onClick={() => setUserRole(userRole === 'manager' ? 'employee' : 'manager')}
              className="w-full flex items-center gap-3 p-3 text-amber-400 hover:bg-gray-800 rounded-lg transition-all text-sm"
            >
              <ShieldCheck size={20} />
              تبديل الصلاحية: {userRole === 'manager' ? 'مدير' : 'موظف'}
            </button>
            <button 
              onClick={() => setView('customers_portal')}
              className="w-full flex items-center gap-3 p-3 text-blue-400 hover:bg-gray-800 rounded-lg transition-all text-sm"
            >
              <UserSquare2 size={20} />
              واجهة العملاء
            </button>
          </div>
        </aside>
      )}

      {/* المحتوى الرئيسي */}
      <main className="flex-1 h-screen overflow-y-auto">
        {/* شريط علوي */}
        <header className="bg-white h-16 border-b flex items-center justify-between px-8 sticky top-0 z-10">
          <div className="flex items-center gap-4">
             {userRole === 'customer' && (
                <div className="flex items-center gap-3 px-2 text-gray-900">
                  <div className="bg-blue-600 p-2 rounded-xl text-white">
                    <LayoutDashboard size={24} />
                  </div>
                  <h1 className="font-black text-xl">متجرنا الإلكتروني</h1>
                </div>
             )}
             <h2 className="text-lg font-bold text-gray-700">
               {view === 'dashboard' && 'نظرة عامة'}
               {view === 'pos' && 'نقطة البيع'}
               {view === 'inventory' && 'المخزون'}
               {view === 'employees' && 'الموظفين'}
               {view === 'customers_portal' && 'واجهة العميل'}
             </h2>
          </div>
          
          <div className="flex items-center gap-6">
            <div className="relative">
              <Bell className="text-gray-400 cursor-pointer" />
              {notifications.length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center">
                  {notifications.length}
                </span>
              )}
            </div>
            <div className="flex items-center gap-3 border-r pr-6">
              <div className="text-left">
                <p className="text-sm font-bold text-gray-800">{userRole === 'manager' ? 'المدير العام' : 'الموظف المسؤول'}</p>
                <p className="text-[10px] text-gray-400">{new Date().toLocaleDateString('ar-SA')}</p>
              </div>
              <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 font-bold">
                {userRole === 'manager' ? 'M' : 'E'}
              </div>
            </div>
          </div>
        </header>

        {/* جسم الصفحة */}
        <div className="p-8">
          {view === 'dashboard' && <DashboardView />}
          {view === 'pos' && <POSView />}
          {view === 'inventory' && <InventoryView />}
          {view === 'employees' && <EmployeesView />}
          {view === 'customers_portal' && <CustomerPortal />}
          {(view === 'returns' || view === 'debts' || view === 'reports') && (
            <div className="bg-white p-20 rounded-2xl border text-center text-gray-400">
              <Settings className="mx-auto mb-4 animate-spin" size={48} />
              <p className="text-lg font-medium">هذه الواجهة قيد التطوير البرمجي حالياً</p>
              <button onClick={() => setView('dashboard')} className="mt-4 text-blue-600 flex items-center gap-2 mx-auto">
                <ChevronRight size={18} /> العودة للرئيسية
              </button>
            </div>
          )}
        </div>
      </main>

      {/* تنسيقات الطباعة */}
      <style>{`
        @media print {
          aside, header, button, .no-print { display: none !important; }
          main { padding: 0 !important; height: auto !important; }
          .print-bill { display: block !important; padding: 20px; font-family: sans-serif; }
        }
      `}</style>
    </div>
  );
};

export default App;
